<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">

  <!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body onload="getCategories()">
  <div class="container-fluid">
    <h1 class="text-center">Supermarket</h1>

    <!-- Dropdown -->
    <div class="row mb-3">
      <div class="col-md-3">
        <span class="lead text-center">Category</span>
      </div>
      <div class="col-md-9">
        <select class="form-select" onchange="getItems()" id="selectCategory">
          <option value="0">To select</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>

    <!-- Items list -->
    <div id="itemsList" class="row my-3 py-3">
      <p class="text-center">No items</p>
    </div>
  </div>

  <script>
    const API = "http://localhost:3010";

    async function getCategories() {
      const select = document.getElementById("selectCategory");
      try {
        select.disabled = true;
        const { data } = await axios.get(`${API}/categories`);
        showCategories(data);
        // load all items initially
        await getItems();
      } catch (err) {
        console.error(err);
        alert("Failed to load categories.");
      } finally {
        select.disabled = false;
      }
    }

    function showCategories(categories = []) {
      const select = document.getElementById("selectCategory");
      select.innerHTML = `
        <option value="0">To select</option>
        <option value="all">All</option>
        ${categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("")}
      `;
    }

    async function getItems() {
      const select = document.getElementById("selectCategory");
      const chosen = select.value;

      if (chosen === "0") {
        showItems([]);
        return;
      }

      const list = document.getElementById("itemsList");
      list.innerHTML = `<p class="text-center">Loadingâ€¦</p>`;

      try {
        let url = `${API}/items`;
        if (chosen !== "all") {
          url += `?category=${encodeURIComponent(chosen)}`;
        }
        const { data } = await axios.get(url);
        showItems(data);
      } catch (err) {
        console.error(err);
        list.innerHTML = `<p class="text-center text-danger">Failed to load items.</p>`;
      }
    }

    function showItems(items = []) {
      const list = document.getElementById("itemsList");

      if (!items.length) {
        list.innerHTML = `<p class="text-center">No items</p>`;
        return;
      }

      list.innerHTML = items.map(item => {
        const name = escapeHtml(item.name ?? "Item");
        const price = Number(item.price ?? 0).toFixed(2);
        return `
          <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title mb-2">${name}</h5>
                <p class="card-text mb-3">Price: $${price}</p>
                <button class="btn btn-outline-primary mt-auto" onclick="addToCart('${name}')">
                  Add to Cart
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function addToCart(name) {
      alert(`${name} added to cart!`);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"></script>
</body>

</html>
